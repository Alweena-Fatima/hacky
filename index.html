<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magical Identity Verification</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cinzel', serif;
            background: linear-gradient(135deg, #0a0a23 0%, #1a1a3e 25%, #2d1b4e 50%, #1a1a3e 75%, #0a0a23 100%);
            color: #d4af37;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Magical Background Effects */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #fff;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.3;
            }

            50% {
                opacity: 1;
            }
        }

        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .floating-element {
            position: absolute;
            font-size: 20px;
            animation: float 6s ease-in-out infinite;
            opacity: 0.6;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px) rotate(0deg);
            }

            50% {
                transform: translateY(-20px) rotate(10deg);
            }
        }

        /* Flying Broomsticks */
        .broomstick {
            position: absolute;
            font-size: 24px;
            color: #8B4513;
            animation: flyAcross 12s linear infinite;
            opacity: 0.7;
        }

        @keyframes flyAcross {
            0% {
                left: -100px;
                top: 50%;
                transform: rotate(25deg);
            }

            25% {
                left: 25%;
                top: 75%;
                transform: rotate(-5deg);
            }

            50% {
                left: 50%;
                top: 75%;
                transform: rotate(20deg);
            }

            75% {
                left: 75%;
                top: 10%;
                transform: rotate(-10deg);
            }

            100% {
                left: calc(100% + 100px);
                top: 20%;
                transform: rotate(5deg);
            }
        }

        /* Hogwarts Houses */
        .house-crests {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            /* Keep this */
            z-index: 5;
            pointer-events: none;
        }

        .house-group-left {
            position: relative;
            left: 200px;
            top: 300px;
            display: grid;
            gap: 100px;
            /* Space between the two left houses */

        }

        .house-group-right {
            position: relative;
            right: 200px;
            top: 300px;
            display: grid;
            gap: 100px;
            /* Space between the two left houses */
        }

        .house-crest {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            animation: housePulse 4s ease-in-out infinite;
            backdrop-filter: blur(5px);
            /* border: 2px solid rgba(255, 255, 255, 0.2); */
        }

        .house-crest gryffindor {
            size: 100px;
        }

        .gryffindor {
            /* background: linear-gradient(135deg, rgba(116, 0, 1, 0.9), rgba(255, 205, 0, 0.9));*/
            color: #c98819;
            background: transparent;
        }

        .hufflepuff {
            /* background: linear-gradient(135deg, rgba(255, 205, 0, 0.9), rgba(0, 0, 0, 0.9)); */
            background: transparent;
            color: #eedb00;
        }

        .ravenclaw {
            /* background: linear-gradient(135deg, rgba(0, 56, 147, 0.9), rgba(173, 216, 230, 0.9)); */
            background: transparent;
            color: #a2e2dd;
        }

        .slytherin {
            /* background: linear-gradient(135deg, rgba(26, 71, 42, 0.9), rgba(192, 192, 192, 0.9)); */
            background: transparent;
            color: #90db72;
        }

        @keyframes housePulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }
        }

        .house-name {
            font-size: 13px;
            margin-top: 2px;
            font-weight: 1000;
        }

        /* Floating Hogwarts Elements */
        .hogwarts-element {
            position: absolute;
            font-size: 18px;
            animation: magicalFloat 8s ease-in-out infinite;
            opacity: 0.4;
        }

        @keyframes magicalFloat {

            0%,
            100% {
                transform: translateY(0px) rotate(0deg) scale(1);
                opacity: 0.4;
            }

            33% {
                transform: translateY(-15px) rotate(5deg) scale(1.1);
                opacity: 0.6;
            }

            66% {
                transform: translateY(-25px) rotate(-5deg) scale(0.9);
                opacity: 0.5;
            }
        }

        /* Magical Particles */
        .magical-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #FFD700;
            border-radius: 50%;
            animation: sparkle 3s linear infinite;
            opacity: 0;
        }

        @keyframes sparkle {

            0%,
            100% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }

            50% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }
        }

        .floating-phrase {
            position: absolute;
            font-size: 14px;
            font-weight: 600;
            color: rgba(212, 175, 55, 0.7);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            animation: phraseFloat 10s ease-in-out infinite;
            opacity: 0.6;
            pointer-events: none;
            white-space: nowrap;
        }

        @keyframes phraseFloat {

            0%,
            100% {
                transform: translateY(0px) rotate(0deg) scale(0.8);
                opacity: 0.3;
            }

            25% {
                transform: translateY(-25px) rotate(2deg) scale(1);
                opacity: 0.8;
            }

            50% {
                transform: translateY(-40px) rotate(-2deg) scale(1.1);
                opacity: 0.9;
            }

            75% {
                transform: translateY(-20px) rotate(1deg) scale(0.9);
                opacity: 0.7;
            }
        }

        /* Main Container */
        .container {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(45deg, #d4af37, #ffd700, #d4af37);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #c0c0c0;
            font-weight: 400;
        }

        /* Step Cards */
        .step-card {
            background: linear-gradient(145deg, rgba(26, 26, 62, 0.9), rgba(45, 27, 78, 0.9));
            border: 2px solid #d4af37;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(212, 175, 55, 0.4);
        }

        .step-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .step-icon-house {
            font-size: 2.5rem;
            margin-bottom: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .step-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #d4af37;
        }

        .step-description {
            font-size: 1.1rem;
            color: #c0c0c0;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* Buttons */
        .magical-button {
            background: linear-gradient(45deg, #d4af37, #ffd700);
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a3e;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .magical-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.5);
        }

        .magical-button:active {
            transform: translateY(0);
        }

        .magical-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .magical-button:hover::before {
            left: 100%;
        }

        /* File Upload */
        .file-upload {
            position: relative;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Progress Bar - Fixed positioning */
        .progress-container {
            position: fixed;
            /* Change back to fixed */
            left: 500px;
            /* Position on right side */
            top: 60%;
            /* Center vertically */
            transform: translateY(-50%);
            /* Perfect vertical centering */
            width: 80px;
            /* Reduce width for vertical layout */
            max-width: none;
            /* Remove max-width */
            margin: 0;
            /* Remove margin */
            z-index: 20;
        }

        .progress-bar {
            background: rgba(26, 26, 62, 0.9);
            border: 2px solid #d4af37;
            border-radius: 25px;
            padding: 10px;
            backdrop-filter: blur(10px);
        }

        .progress-steps {
            display: flex;
            flex-direction: column;
            /* Change to column for vertical */
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
            /* Remove bottom margin */
            height: 300px;
            /* Set fixed height for vertical spacing */
        }

        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .progress-step.active {
            background: #d4af37;
            color: #1a1a3e;
            animation: glow 2s infinite;
        }

        .progress-step.completed {
            background: #4CAF50;
            color: white;
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(212, 175, 55, 0.8);
            }
        }

        .progress-line {
            flex: 1;
            width: 2px;
            /* Change width instead of height */
            height: auto;
            /* Remove fixed height */
            background: rgba(212, 175, 55, 0.3);
            margin: 5px 0;
            /* Change margin to vertical */
            position: relative;
        }

        .progress-line.completed::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: #d4af37;
            animation: progressFill 0.5s ease;
        }

        @keyframes progressFill {
            from {
                width: 0;
            }

            to {
                width: 100%;
            }
        }

        /* Loading Animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
        }

        .loading-spell {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(212, 175, 55, 0.3);
            border-top: 4px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Data Display */
        .data-display {
            background: rgba(26, 26, 62, 0.7);
            border: 1px solid #d4af37;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .data-item {
            margin: 10px 0;
            padding: 10px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 8px;
        }

        .data-label {
            font-weight: 600;
            color: #d4af37;
        }

        .data-value {
            color: #c0c0c0;
            margin-left: 10px;
        }

        .extracted-image {
            max-width: 150px;
            max-height: 150px;
            border-radius: 10px;
            border: 2px solid #d4af37;
            margin: 10px 0;
        }

        /* Camera Section */
        .camera-container {
            position: relative;
            margin: 20px 0;
        }

        #video {
            width: 100%;
            max-width: 400px;
            border-radius: 15px;
            border: 2px solid #d4af37;
        }

        .camera-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #d4af37;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Result Display */
        .result {
            margin: 20px 0;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .result.success {
            background: linear-gradient(45deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1));
            border: 2px solid #4CAF50;
            color: #4CAF50;
        }

        .result.failure {
            background: linear-gradient(45deg, rgba(244, 67, 54, 0.2), rgba(244, 67, 54, 0.1));
            border: 2px solid #f44336;
            color: #f44336;
        }

        /* Hidden class */
        .hidden {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }

            .step-card {
                padding: 30px 20px;
            }

            .progress-container {
                width: 250px;
            }
        }
    </style>
</head>

<body>
    <!-- Magical Background Effects -->
    <div class="stars" id="stars"></div>
    <div class="floating-elements" id="floating-elements"></div>

    <div class="house-crests">
        <div class="house-group-left">
            <div class="house-crest gryffindor">
                <div class="step-icon-house">🦁</div>
                <div class="house-name">GRYFFINDOR</div>
            </div>
            <div class="house-crest hufflepuff">
                <div class="step-icon-house">🦡</div>
                <div class="house-name">HUFFLEPUFF</div>
            </div>
        </div>
        <div class="house-group-right">
            <div class="house-crest ravenclaw">
                <div class="step-icon-house">🦅</div>
                <div class="house-name">RAVENCLAW</div>
            </div>
            <div class="house-crest slytherin">
                <div class="step-icon-house">🐍</div>
                <div class="house-name">SLYTHERIN</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1 class="title">✨ Magical Identity Verification ✨</h1>
            <p class="subtitle">Ministry of Magic - Age Verification Department</p>
        </div>

        <!-- Step 1: Start Verification -->
        <div id="step1" class="step-card">
            <div class="step-icon">🔮</div>
            <h2 class="step-title">Platform 9¾</h2>
            <p class="step-description">
                Welcome, young wizard! To access the magical realm, we must verify your identity and age.
                Click the enchanted button below to start your verification quest.
            </p>
            <button class="magical-button" onclick="nextStep(2)">
                🪄 Start Verification
            </button>
        </div>

        <!-- Step 2: Upload Document -->
        <div id="step2" class="step-card hidden">
            <div class="step-icon">🎩</div>
            <h2 class="step-title">Upload Your Magical Document</h2>
            <p class="step-description">
                Please upload your Aadhar card (or any identity document). Our magical OCR spells
                will extract your information safely.
            </p>
            <div class="file-upload">
                <button class="magical-button" onclick="triggerFileUpload()">
                    📸 Choose Document from Computer
                </button>
                <input type="file" class="file-input" id="documentUpload" accept="image/*,.pdf"
                    onchange="handleFileUpload(event)" style="display: none;">
            </div>
            <p style="color: #c0c0c0; font-size: 0.9rem; margin-top: 15px;">
                📝 Supported formats: JPG, PNG, PDF
            </p>
        </div>

        <!-- Step 3: Processing & Data Display -->
        <div id="step3" class="step-card hidden">
            <div class="step-icon">🪄</div>
            <h2 class="step-title">Casting Extraction Spells</h2>
            <p class="step-description">Our magical algorithms are analyzing your document...</p>

            <div id="loading" class="loading">
                <div class="loading-spell"></div>
            </div>

            <div id="extractedData" class="data-display hidden">
                <h3 style="color: #d4af37; margin-bottom: 15px;">📋 Extracted Information</h3>
                <!-- <div class="data-item">
                    <span class="data-label">Name:</span>
                    <span class="data-value" id="extractedName">Harry James Potter</span>
                </div> -->
                <div class="data-item">
                    <span class="data-label">Date of Birth:</span>
                    <span class="data-value" id="extractedDOB">31/07/1980</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Age:</span>
                    <span class="data-value" id="extractedAge"></span>
                </div>
                <div class="data-item">
                    <span class="data-label">Document Photo:</span><br>
                    <img id="extractedPhoto" class="extracted-image"
                        src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSIjMWExYTNlIiBzdHJva2U9IiNkNGFmMzciIHN0cm9rZS13aWR0aD0iMiIvPgo8Y2lyY2xlIGN4PSI3NSIgY3k9IjYwIiByPSIyNSIgZmlsbD0iI2Q0YWYzNyIvPgo8cGF0aCBkPSJNNDUgMTIwIFE3NSA5MCA1MiAxMDUgUTc1IDkwIDEwNSAxMjBaIiBmaWxsPSIjZDRhZjM3Ii8+Cjx0ZXh0IHg9Ijc1IiB5PSIxNDAiIHRleHQtYW5jaG9yPSJtaWRkZSIgZmlsbD0iI2Q0YWYzNyIgZm9udC1zaXplPSIxMiI+UGhvdG88L3RleHQ+Cjwvc3ZnPgo="
                        alt="Extracted Photo">
                </div>
                <button class="magical-button" onclick="nextStep(4)" style="margin-top: 20px;">
                    📷 Proceed to Live Verification
                </button>
            </div>
        </div>

        <!-- Step 4: Live Photo Verification -->
        <div id="step4" class="step-card hidden">
            <div class="step-icon">🎭</div>
            <h2 class="step-title">Live Magical Recognition</h2>
            <p class="step-description">
                Now we'll capture your live image to verify it's really you. Look into the crystal ball!
            </p>

            <!-- Camera Instructions -->
            <div id="cameraInstructions" class="data-display" style="margin-bottom: 20px;">
                <h4 style="color: #d4af37; margin-bottom: 10px;">📝 Camera Setup Guide:</h4>
                <ul style="text-align: left; color: #c0c0c0; font-size: 0.9rem;">
                    <li>✓ Click "Allow" when browser asks for camera permission</li>
                    <li>✓ Make sure you have a camera connected</li>
                    <li>✓ Use HTTPS or localhost (required by browsers)</li>
                    <li>✓ Check if another app is using your camera</li>
                    <li>✓ Try refreshing the page if it doesn't work</li>
                </ul>
            </div>

            <div class="camera-container">
                <video id="video" autoplay playsinline style="display: none;"></video>
                <div class="camera-overlay" id="cameraOverlay" style="display: none;"></div>
                <canvas id="canvas" style="display: none;"></canvas>
            </div>

            <button id="startCameraBtn" class="magical-button" onclick="startCamera()">
                📹 Activate Magical Mirror
            </button>

            <button id="captureBtn" class="magical-button hidden" onclick="capturePhoto()" style="margin-left: 10px;">
                ✨ Capture Magical Essence
            </button>

            <!-- Skip Camera Option -->
            <div style="margin-top: 20px;">
                <button class="magical-button" onclick="skipCamera()"
                    style="background: linear-gradient(45deg, #666, #888); font-size: 0.9rem;">
                    ⏭️ Skip Camera (Demo Mode)
                </button>
            </div>

            <div id="verificationResult" class="result hidden">
                <!-- Results will be displayed here -->
            </div>

            <button id="restartBtn" class="magical-button hidden" onclick="restart()" style="margin-top: 20px;">
                🔄 Start New Verification
            </button>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-steps">
                <div class="progress-step active" id="progress1">1</div>
                <div class="progress-line" id="line1"></div>
                <div class="progress-step" id="progress2">2</div>
                <div class="progress-line" id="line2"></div>
                <div class="progress-step" id="progress3">3</div>
                <div class="progress-line" id="line3"></div>
                <div class="progress-step" id="progress4">4</div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let extractedData = {};
        let stream = null;

        // Initialize magical effects
        function initMagicalEffects() {
            createStars();
            createFloatingElements();
        }

        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }

        function createFloatingElements() {
            const container = document.getElementById('floating-elements');
            const magicalElements = ['✨', '⭐', '🌟', '💫', '🔮', '🪄', '⚡'];
            const hogwartsElements = ['🏰', '📜', '🦉', '🕯️', '⚗️', '🎓', '📚', '🗝️', '🏉'];
            const phasesElements = [
                'Wingardium Leviosa', 'Expecto Patronum',
                'Alohomora', 'Dobby is free', 'After all this time?',
                'Avada Kedavra', 'Sectumsempra',
                'Riddikulus', 'I solemnly swear', 'Always...', 'Muggles', 'Quidditch',
                'Hogwarts Express', 'Gryffindor!'
            ];

            // Create regular floating magical elements
            for (let i = 0; i < 10; i++) {
                const element = document.createElement('div');
                element.className = 'floating-element';
                element.textContent = magicalElements[Math.floor(Math.random() * magicalElements.length)];
                element.style.left = Math.random() * 100 + '%';
                element.style.top = Math.random() * 100 + '%';
                element.style.animationDelay = Math.random() * 6 + 's';
                element.style.animationDuration = (4 + Math.random() * 4) + 's';
                container.appendChild(element);
            }

            // Create Hogwarts-themed floating elements
            for (let i = 0; i < hogwartsElements.length; i++) {
                const element = document.createElement('div');
                element.className = 'hogwarts-element';
                element.textContent = hogwartsElements[Math.floor(Math.random() * hogwartsElements.length)];
                element.style.left = Math.random() * 100 + '%';
                element.style.top = Math.random() * 100 + '%';
                element.style.animationDelay = Math.random() * 8 + 's';
                element.style.animationDuration = (6 + Math.random() * 4) + 's';
                container.appendChild(element);
            }

            // Create flying broomsticks
            for (let i = 0; i < 3; i++) {
                const broomstick = document.createElement('div');
                broomstick.className = 'broomstick';
                broomstick.innerHTML = '🧙🧹'; // Wizard on broomstick
                broomstick.style.animationDelay = (i * 4) + 's';
                broomstick.style.animationDuration = (10 + Math.random() * 4) + 's';
                broomstick.style.top = (10 + Math.random() * 60) + '%';
                container.appendChild(broomstick);
            }
            // Create flying broomsticks
            for (let i = 0; i < 3; i++) {
                const broomstick = document.createElement('div');
                broomstick.className = 'broomstick';
                broomstick.innerHTML = '🧙‍♂️🧹'; // Wizard on broomstick
                broomstick.style.animationDelay = (i * 4) + 's';
                broomstick.style.animationDuration = (10 + Math.random() * 4) + 's';
                broomstick.style.top = (10 + Math.random() * 60) + '%';
                container.appendChild(broomstick);
            }

            // Create magical particles
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'magical-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 3 + 's';
                particle.style.animationDuration = (2 + Math.random() * 2) + 's';
                container.appendChild(particle);
            }
            // Create floating Hogwarts phrases
            for (let i = 0; i < 6; i++) {
                const phrase = document.createElement('div');
                phrase.className = 'floating-phrase';
                phrase.textContent = phasesElements[Math.floor(Math.random() * phasesElements.length)];
                phrase.style.left = Math.random() * 100 + '%';
                phrase.style.top = Math.random() * 100 + '%';
                phrase.style.animationDelay = Math.random() * 10 + 's';
                phrase.style.animationDuration = (8 + Math.random() * 6) + 's';
                container.appendChild(phrase);
            }
        }

        function nextStep(step) {
            // Hide current step
            document.getElementById(`step${currentStep}`).classList.add('hidden');

            // Update progress
            document.getElementById(`progress${currentStep}`).classList.remove('active');
            document.getElementById(`progress${currentStep}`).classList.add('completed');

            if (currentStep < 4) {
                document.getElementById(`line${currentStep}`).classList.add('completed');
            }

            currentStep = step;

            // Show next step
            document.getElementById(`step${currentStep}`).classList.remove('hidden');
            document.getElementById(`progress${currentStep}`).classList.add('active');
        }

        function triggerFileUpload() {
            document.getElementById('documentUpload').click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                console.log('File selected:', file.name);
                nextStep(3); // show step 3 (loading spinner)

                const formData = new FormData();
                formData.append("file", file);

                fetch("http://127.0.0.1:5000/extract", {
                    method: "POST",
                    body: formData,
                })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById("loading").classList.add("hidden");
                        document.getElementById("extractedData").classList.remove("hidden");

                        // Set DOB first
                        const dob = data.dob || "Not found";
                        document.getElementById("extractedDOB").textContent = dob;

                        // Then calculate age
                        if (dob && dob !== "Not found") {
                            try {
                                const age = calculateAgeFromDOB(dob);
                                console.log("Final age result:", age); // Debug log
                                document.getElementById("extractedAge").textContent =
                                    (typeof age === 'number') ? `${age} years` : age;
                            } catch (error) {
                                console.error("Age calculation error:", error);
                                document.getElementById("extractedAge").textContent = "Error calculating age";
                            }
                        } else {
                            document.getElementById("extractedAge").textContent = "Not found";
                        }

                        // Rest of your code...
                    })

                    .catch(error => {
                        console.error("Error during OCR:", error);
                    });
            }
        }
        function calculateAgeFromDOB(dobString) {
            console.log("Received DOB string:", dobString); // Debug log

            // Return if no DOB provided
            if (!dobString || dobString === "Not found") {
                console.log("No DOB provided");
                return "Not found";
            }

            // First try parsing as ISO format (YYYY-MM-DD)
            let dob = new Date(dobString);
            console.log("First parse attempt:", dob); // Debug log

            // If that fails, try DD/MM/YYYY format
            if (isNaN(dob.getTime())) {
                console.log("Trying DD/MM/YYYY format"); // Debug log
                const parts = dobString.split("/").map(Number);

                if (parts.length === 3) {
                    // Validate date components
                    if (parts[1] < 1 || parts[1] > 12) {
                        console.log("Invalid month");
                        return "Invalid date";
                    }

                    // Note: months are 0-indexed in JavaScript Date
                    dob = new Date(parts[2], parts[1] - 1, parts[0]);
                    console.log("Second parse attempt:", dob); // Debug log
                } else if (parts.length === 1 && !isNaN(parts[0])) {
                    // Only year provided
                    const age = new Date().getFullYear() - parts[0];
                    console.log("Year-only age:", age); // Debug log
                    return age;
                } else {
                    console.log("Unexpected date format");
                    return "Invalid date format";
                }
            }

            // Check if date is valid
            if (isNaN(dob.getTime())) {
                console.log("Final date validation failed");
                return "Invalid date";
            }

            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();

            console.log("Initial age calculation:", age); // Debug log
            console.log("Month difference:", monthDiff); // Debug log
            console.log("Day comparison:", today.getDate(), "<", dob.getDate()); // Debug log

            // Adjust age if birthday hasn't occurred yet this year
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                age--;
                console.log("Adjusted age:", age); // Debug log
            }

            return age;
        }



        async function startCamera() {
            try {
                console.log('Requesting camera access...');

                // Check if navigator.mediaDevices is available
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera API not supported in this browser');
                }

                // Request camera with specific constraints for better compatibility
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user' // Front camera preferred
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('video');

                video.srcObject = stream;
                video.style.display = 'block';

                // Wait for video to be ready
                video.onloadedmetadata = () => {
                    console.log('Camera activated successfully!');
                    video.play();
                };

                document.getElementById('cameraOverlay').style.display = 'block';
                document.getElementById('startCameraBtn').classList.add('hidden');
                document.getElementById('captureBtn').classList.remove('hidden');
                document.getElementById('cameraInstructions').style.display = 'none';

            } catch (error) {
                console.error('Camera error:', error);
                let errorMessage = '';
                let solutions = '';

                if (error.name === 'NotAllowedError') {
                    errorMessage = '🚫 Camera Access Denied';
                    solutions = `
                        <div style="margin-top: 10px; text-align: left;">
                        <strong>How to fix:</strong><br>
                        1. Look for 🎥 icon in your browser address bar<br>
                        2. Click it and select "Allow"<br>
                        3. Or go to browser Settings → Privacy → Camera<br>
                        4. Refresh the page and try again
                        </div>
                    `;
                } else if (error.name === 'NotFoundError') {
                    errorMessage = '📹 No Camera Found';
                    solutions = 'Please connect a camera to your device and try again.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = '🌐 Browser Not Supported';
                    solutions = 'Please use Chrome, Firefox, Safari, or Edge browser.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = '🔒 Camera In Use';
                    solutions = 'Another app might be using your camera. Close other apps and try again.';
                } else {
                    errorMessage = '⚠️ Camera Error';
                    solutions = 'Please check your camera settings and try again.';
                }

                // Show error in a magical way
                const resultDiv = document.getElementById('verificationResult');
                resultDiv.className = 'result failure';
                resultDiv.innerHTML = `
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">❌</div>
                    <div style="font-size: 1.1rem; margin-bottom: 10px;">${errorMessage}</div>
                    <div style="font-size: 0.9rem;">${solutions}</div>
                `;
                resultDiv.classList.remove('hidden');
            }
        }

        function skipCamera() {
            // Hide instructions and show demo result
            document.getElementById('cameraInstructions').style.display = 'none';
            document.getElementById('startCameraBtn').classList.add('hidden');

            // Show demo verification result
            setTimeout(() => {
                const resultDiv = document.getElementById('verificationResult');
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 10px;">✅</div>
                    <div>Demo Mode - Verification Simulated!</div>
                    <div style="font-size: 0.9rem; margin-top: 10px;">
                        Age: ${extractedData.age} years (✓ 18+)<br>
                        Face Match: 95% (✓ Demo Verified)<br>
                        Status: Access Granted to Magical Realm<br>
                        <em>Note: This is a demo simulation</em>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
                document.getElementById('restartBtn').classList.remove('hidden');
            }, 1000);
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            // Stop camera
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            video.style.display = 'none';
            document.getElementById('cameraOverlay').style.display = 'none';
            document.getElementById('captureBtn').classList.add('hidden');

            // Simulate verification process
            setTimeout(() => {
                showVerificationResult();
            }, 2000);
        }

        function showVerificationResult() {
            const resultDiv = document.getElementById('verificationResult');
            const isSuccess = Math.random() > 0.3; // 70% success rate for demo

            if (isSuccess) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 10px;">✅</div>
                    <div>Verification Successful!</div>
                    <div style="font-size: 0.9rem; margin-top: 10px;">
                        Age: ${extractedData.age} years (✓ 18+)<br>
                        Face Match: 94% (✓ Verified)<br>
                        Status: Access Granted to Magical Realm
                    </div>
                `;
            } else {
                resultDiv.className = 'result failure';
                resultDiv.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 10px;">❌</div>
                    <div>Verification Failed</div>
                    <div style="font-size: 0.9rem; margin-top: 10px;">
                        Face Match: 45% (✗ Below threshold)<br>
                        Please try again with better lighting
                    </div>
                `;
            }

            resultDiv.classList.remove('hidden');
            document.getElementById('restartBtn').classList.remove('hidden');
        }

        function restart() {
            // Reset everything
            currentStep = 1;
            extractedData = {};

            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
                document.getElementById(`progress${i}`).classList.remove('active', 'completed');
                if (i < 4) {
                    document.getElementById(`line${i}`).classList.remove('completed');
                }
            }

            // Show first step
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('progress1').classList.add('active');

            // Reset file input
            document.getElementById('documentUpload').value = '';

            // Reset step 3
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('extractedData').classList.add('hidden');

            // Reset step 4
            document.getElementById('video').style.display = 'none';
            document.getElementById('cameraOverlay').style.display = 'none';
            document.getElementById('startCameraBtn').classList.remove('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('verificationResult').classList.add('hidden');
            document.getElementById('restartBtn').classList.add('hidden');
        }

        // Initialize on page load
        window.addEventListener('load', initMagicalEffects);
    </script>
</body>

</html>